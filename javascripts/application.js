// Generated by CoffeeScript 1.4.0
(function() {
  var desired, geocode, parseResults, query, results;

  $(function() {
    return geocode('10001');
  });

  desired = [114, 151, 156, 153, 145, 144, 114, 151, 163, 164, 116, 131, 103];

  desired = [76, 105, 110, 107, 101, 100, 76, 105, 115, 116, 78, 89, 67];

  results = [];

  geocode = function(address) {
    return $.ajax({
      url: "./geocode_request.php?address=" + address,
      type: 'GET',
      success: function(data) {
        var coords, lat, lng, location;
        location = JSON.parse(data).results[0].geometry.location;
        lat = location.lat;
        lng = location.lng;
        coords = "" + lat + "," + lng;
        return query(coords);
      }
    });
  };

  query = function(coords, radius, next_page) {
    var data;
    if (radius == null) {
      radius = 20000;
    }
    if (next_page == null) {
      next_page = false;
    }
    console.log("starting a " + (next_page != null ? 'next page ' : void 0) + "query within " + radius + "m of '" + coords + "'");
    if (next_page) {
      data = {
        next_page: next_page
      };
    } else {
      data = {
        location: coords,
        radius: radius,
        types: 'food',
        name: 'coffee'
      };
    }
    return $.ajax({
      type: 'GET',
      url: "./request.php",
      data: data,
      success: function(data) {
        var addresses, request_results, response;
        response = JSON.parse(data);
        request_results = response.results;
        console.log(response);
        addresses = _.map(request_results, function(result) {
          var _ref;
          return (_ref = result.vicinity.match(/^\d+/)) != null ? _ref[0] : void 0;
        });
        if (addresses.length > 0) {
          console.log("we found some addresses to search! " + (_.compact(addresses)));
          parseResults(request_results);
          if (response.next_page_token != null) {
            console.log('waiting 3s for the next page token to become valid');
            return _.delay(function() {
              return query(coords, radius, response.next_page_token);
            }, 3000);
          }
        } else {
          return console.log('no addresses found in this search :(');
        }
      }
    });
  };

  parseResults = function(request_results) {
    results = _.union(results, _.filter(request_results, function(result) {
      var _ref;
      return _.contains(desired, parseInt((_ref = result.vicinity.match(/^\d+/)) != null ? _ref[0] : void 0));
    }));
    _.each(request_results, function(result) {
      return desired = _.reject(desired, function(num) {
        var _ref;
        return num === parseInt((_ref = result.vicinity.match(/^\d+/)) != null ? _ref[0] : void 0);
      });
    });
    console.log("current results:", results);
    return console.log("but we're still looking for " + desired);
  };

}).call(this);
